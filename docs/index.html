// Click teammate name to enter edit mode (event delegation) if
(e.target.classList.contains("team-name-text")) { const td =
e.target.parentElement; td.querySelector(".team-name-text").style.display =
"none"; td.querySelector(".team-name-input").style.display = "inline-block";
const renameBtn = td.parentElement.querySelector(".rename-person"); if
(renameBtn) renameBtn.style.display = "none";
td.querySelector(".save-person").style.display = "inline-block";
td.querySelector(".team-name-input").focus(); }
<html lang="en">
  <head>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekend Call Schedule</title>
    <!-- D3.js v3 for bell curve chart -->
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
        background-color: #f6f8fa;
        color: #24292e;
      }

      .container {
        width: 100vw;
        max-width: 100vw;
        margin: 0;
        background-color: #fff;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(27, 31, 35, 0.1);
        box-sizing: border-box;
      }

      h1,
      h2 {
        text-align: left;
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .input-group input[type="number"],
      .input-group input[type="date"],
      #add-person-input {
        width: calc(100% - 22px);
        padding: 8px 10px;
        border: 1px solid #d1d5da;
        border-radius: 3px;
      }

      #add-person-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      #add-person-input {
        flex-grow: 1;
      }

      #add-person-btn {
        padding: 8px 15px;
        background-color: #28a745;
        color: #fff;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }

      #add-person-btn:hover {
        background-color: #22863a;
      }

      .input-group input[type="checkbox"] {
        margin-right: 5px;
      }

      #team-list {
        margin-top: 10px;
        padding: 0;
        list-style: none;
      }

      #team-list li {
        background-color: #fafbfc;
        border: 1px solid #e1e4e8;
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: move;
      }

      #team-list li.dragging {
        opacity: 0.5;
      }

      .person-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .person-info input[type="color"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-color: transparent;
        width: 40px;
        height: 40px;
        border: none;
        cursor: pointer;
      }

      .remove-person {
        background-color: #cb2431;
        color: #fff;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
      }

      #calculate {
        width: 100%;
        padding: 10px;
        background-color: #28a745;
        color: #fff;
        border: none;
        border-radius: 3px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
      }

      #calculate:hover {
        background-color: #22863a;
      }

      #results {
        margin-top: 20px;
      }

      #results h2 {
        text-align: left;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      th,
      td {
        border: 1px solid #d1d5da;
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #f6f8fa;
      }

      .tracker-chart-container {
        margin-top: 30px;
        border: 1px solid #e1e4e8;
        padding: 10px;
        border-radius: 6px;
        background-color: #ebedf0;
        overflow-x: auto;
        height: 220px;
        min-height: 220px;
      }
      .bell-curve-chart-container {
        margin-top: 30px;
        border: 1px solid #e1e4e8;
        padding: 10px;
        border-radius: 6px;
        background-color: #ebedf0;
        overflow-x: auto;
        height: 500px;
        min-height: 500px;
      }

      .chart-grid {
        display: grid;
        grid-template-columns: 60px repeat(53, 1fr);
        grid-template-rows: repeat(7, 1fr);
        gap: 2px;
        padding-bottom: 10px;
        background-color: #fff;
      }

      .day-label {
        font-size: 12px;
        font-weight: bold;
        text-align: right;
        padding-right: 5px;
        color: #586069;
        align-self: center;
        grid-column: 1;
      }

      .day-box {
        width: calc((100vw - 120px) / 54);
        height: calc((100vw - 120px) / 54);
        max-width: 18px;
        max-height: 18px;
        min-width: 8px;
        min-height: 8px;
        background-color: #ebedf0;
        border-radius: 1px;
        box-sizing: border-box;
        position: relative;
        transition: width 0.2s, height 0.2s;
      }

      .day-box.gray-out {
        background-color: #e1e4e8;
        cursor: not-allowed;
      }

      .day-box .tooltip {
        visibility: hidden;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
      }

      .day-box:hover .tooltip {
        visibility: visible;
      }

      .day-box .tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
      }

      .month-header {
        display: flex;
        margin-left: 60px; /* Align with the grid below */
        margin-bottom: 5px;
        font-size: 12px;
        color: #586069;
        width: calc(
          100% - 60px
        ); /* Match the width of the grid minus the day labels */
      }

      .month-label {
        text-align: center;
        padding-bottom: 5px;
        border-bottom: 1px solid #e1e4e8;
        flex-grow: 0;
        flex-shrink: 0;
      }

      /* Toggle switch styles */
      .switch-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
        margin: 0 10px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #28a745;
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .date-mode-container {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container-flex">
      <!-- Row 1: Tracking chart full width -->
      <div class="tracker-chart-container" style="width: 100%">
        <h2>Annual Call Chart</h2>
        <div id="chartGridWrapper"></div>
      </div>

      <!-- Row 2: Bell curve half width, controls half width -->
      <div
        style="
          display: flex;
          gap: 32px;
          align-items: flex-start;
          width: 100%;
          margin-top: 20px;
        "
      >
        <div
          class="bell-curve-chart-container"
          style="flex: 1; min-width: 500px"
        >
          <h2>Standard Deviation Chart</h2>

          <div id="stdDevChartWrapper"></div>
        </div>
        <div class="input-group" style="flex: 1; min-width: 320px">
          <label><strong>Controls</strong></label>
          <div class="switch-container">
            <span>Specific Start Date</span>
            <label class="switch">
              <input type="checkbox" id="dateMode" />
              <span class="slider"></span>
            </label>
            <span>Next 13 Months</span>
          </div>
          <div style="margin-bottom: 8px">
            <label
              ><input type="checkbox" id="toggle12Months" /> Next 132
              Months</label
            >
          </div>
          <div class="date-mode-container">
            <div id="specificDateContainer" class="input-group">
              <label for="startDate">Start Date:</label>
              <input type="date" id="startDate" />
            </div>
          </div>
          <div style="margin-bottom: 8px">
            <label for="shiftLength">Shift Length (days):</label>
            <input type="number" id="shiftLength" min="1" max="14" value="7" />
          </div>
          <div style="margin-bottom: 8px">
            <label
              ><input type="checkbox" id="includeFriday" /> Include
              Friday</label
            >
          </div>
        </div>
      </div>

      <!-- Row 3: Team Members Input half width, Results table half width -->
      <div
        style="
          display: flex;
          gap: 32px;
          align-items: flex-start;
          width: 100%;
          margin-top: 20px;
        "
      >
        <div class="input-group" style="flex: 1; min-width: 320px">
          <label>Team Members (Drag to reorder):</label>
          <div id="add-person-container">
            <input type="text" id="add-person-input" placeholder="Enter name" />
            <button id="add-person-btn">Add</button>
          </div>
          <table
            id="team-table"
            style="width: 100%; border-collapse: collapse; margin-top: 15px"
          >
            <thead>
              <tr>
                <th>Color</th>
                <th>Person</th>
                <th>Weekend Call Days</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody id="team-table-body"></tbody>
          </table>
        </div>
        <div
          id="results"
          style="flex: 1; min-width: 300px; display: none"
        ></div>
      </div>
    </div>
    <div id="roadsigns" class="row">
      <div class="col-6">
        <div id="mean-roadsign" class="card text-center shadow-lg w-100">
          <div class="card-body p-4">
            <div class="card-title h6 mb-2">Mean Weekend Days</div>
            <span id="mean" class="display-5 fw-bold"></span>
          </div>
        </div>
      </div>
      <div class="col-6">
        <div id="stddev-roadsign" class="card text-center shadow-lg w-100">
          <div class="card-body p-4">
            <div class="card-title h6 mb-2">Standard Deviation</div>
            <span id="stdDev" class="display-5 fw-bold"></span>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const PEOPLE_STORAGE_KEY = "callSchedulerPeople";
    const SETTINGS_STORAGE_KEY = "callSchedulerSettings";
    let peopleList = [];

    const addPersonInput = document.getElementById("add-person-input");
    const addPersonBtn = document.getElementById("add-person-btn");
    // const teamListUl = document.getElementById('team-list');
    const chartGridWrapper = document.getElementById("chartGridWrapper");
    const startDateInput = document.getElementById("startDate");
    const shiftLengthInput = document.getElementById("shiftLength");
    const includeFridayCheckbox = document.getElementById("includeFriday");
    const dateModeToggle = document.getElementById("dateMode");
    const specificDateContainer = document.getElementById(
      "specificDateContainer"
    );

    const colorPalette = [
      "#E69F00",
      "#56B4E9",
      "#009E73",
      "#F0E442",
      "#0072B2",
      "#D55E00",
      "#CC79A7",
    ];

    let dragSrcEl = null;

    // --- Core Functions ---

    function savePeople() {
      localStorage.setItem(PEOPLE_STORAGE_KEY, JSON.stringify(peopleList));
    }

    function saveSettings() {
      const settings = {
        startDate: startDateInput.value,
        shiftLength: shiftLengthInput.value,
        includeFriday: includeFridayCheckbox.checked,
        useNext12Months: dateModeToggle.checked,
      };
      localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
    }

    function loadSettings() {
      const storedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
      if (storedSettings) {
        const settings = JSON.parse(storedSettings);

        // Apply saved start date or use today's date as default
        if (settings.startDate) {
          startDateInput.value = settings.startDate;
        } else {
          const today = new Date();
          const todayISO = today.toISOString().split("T")[0];
          startDateInput.value = todayISO;
        }

        // Apply saved shift length or use default
        if (settings.shiftLength) {
          shiftLengthInput.value = settings.shiftLength;
        }

        // Apply saved Friday inclusion setting
        if (settings.includeFriday !== undefined) {
          includeFridayCheckbox.checked = settings.includeFriday;
        }

        // Apply saved date mode setting
        if (settings.useNext12Months !== undefined) {
          dateModeToggle.checked = settings.useNext12Months;
          updateDateModeDisplay();
        }
      } else {
        // Default to today's date if no settings are saved
        const today = new Date();
        const todayISO = today.toISOString().split("T")[0];
        startDateInput.value = todayISO;
      }
    }

    // Function to update the date mode display
    function updateDateModeDisplay() {
      if (dateModeToggle.checked) {
        // Next 12 months mode
        specificDateContainer.style.display = "none";
        document.querySelector(".tracker-chart-container h2").textContent =
          "Next 12 Months Call Chart";
      } else {
        // Specific start date mode
        specificDateContainer.style.display = "block";
        document.querySelector(".tracker-chart-container h2").textContent =
          "Annual Call Chart";
      }
      calculateSchedule();
    }

    function loadPeople() {
      const storedPeople = localStorage.getItem(PEOPLE_STORAGE_KEY);
      if (storedPeople) {
        peopleList = JSON.parse(storedPeople);
      }
      renderPeopleList();
      calculateSchedule();
    }

    function addPerson() {
      const name = addPersonInput.value.trim();
      if (name) {
        const defaultColor =
          colorPalette[peopleList.length % colorPalette.length];
        peopleList.push({ name: name, color: defaultColor });
        addPersonInput.value = "";
        renderPeopleList();
        savePeople();
        calculateSchedule();
      }
    }

    function removePerson(index) {
      peopleList.splice(index, 1);
      renderPeopleList();
      savePeople();
      calculateSchedule();
    }

    function renderPeopleList() {
      // teamListUl.innerHTML = '';
      const teamTableBody = document.getElementById("team-table-body");
      if (!teamTableBody) return;
      teamTableBody.innerHTML = "";
      peopleList.forEach((person, index) => {
        const tr = document.createElement("tr");
        tr.draggable = true;
        tr.dataset.index = index;
        // Color cell
        const colorTd = document.createElement("td");
        colorTd.innerHTML = `<input type="color" value="${person.color}" data-index="${index}">`;
        tr.appendChild(colorTd);
        // Name cell with rename input only
        const nameTd = document.createElement("td");
        nameTd.className = "team-name-cell";
        nameTd.innerHTML = `
            <span class="team-name-text">${person.name}</span>
            <input type="text" class="team-name-input form-control form-control-sm" value="${person.name}" style="display:none; width: 70%; margin-right: 4px;">
            <button class="save-person btn btn-success btn-sm" data-index="${index}" style="display:none;">Save</button>
          `;
        tr.appendChild(nameTd);
        // Weekend Call Days cell (filled later)
        const daysTd = document.createElement("td");
        daysTd.className = "weekend-call-days";
        daysTd.textContent = "";
        tr.appendChild(daysTd);
        // Remove and Rename button cell
        const actionTd = document.createElement("td");
        actionTd.innerHTML = `
            <button class="remove-person btn btn-danger btn-sm" data-index="${index}">Remove</button>
            <button class="rename-person btn btn-outline-secondary btn-sm" data-index="${index}">Rename</button>
          `;
        tr.appendChild(actionTd);
        // Drag events
        tr.addEventListener("dragstart", handleDragStart);
        tr.addEventListener("dragover", handleDragOver);
        tr.addEventListener("drop", handleDrop);
        tr.addEventListener("dragend", handleDragEnd);
        teamTableBody.appendChild(tr);
      });
    }

    function handleDragStart(e) {
      this.style.opacity = "0.5";
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", this.dataset.index);
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    }

    function handleDrop(e) {
      e.stopPropagation();
      if (dragSrcEl !== this) {
        const dragIndex = parseInt(e.dataTransfer.getData("text/plain"));
        const dropIndex = parseInt(this.dataset.index);
        const [draggedItem] = peopleList.splice(dragIndex, 1);
        peopleList.splice(dropIndex, 0, draggedItem);
        renderPeopleList();
        savePeople();
        calculateSchedule();
      }
    }

    function handleDragEnd(e) {
      this.style.opacity = "1";
      renderPeopleList();
    }

    // --- Event Listeners ---
    addPersonBtn.addEventListener("click", addPerson);
    addPersonInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        addPerson();
      }
    });

    document
      .getElementById("team-table-body")
      .addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-person")) {
          const index = e.target.dataset.index;
          removePerson(index);
        }
        // Rename button toggles input
        if (e.target.classList.contains("rename-person")) {
          // Find the row and the name cell
          const tr = e.target.closest("tr");
          const nameTd = tr.querySelector(".team-name-cell");
          nameTd.querySelector(".team-name-text").style.display = "none";
          nameTd.querySelector(".team-name-input").style.display =
            "inline-block";
          e.target.style.display = "none";
          nameTd.querySelector(".save-person").style.display = "inline-block";
          nameTd.querySelector(".team-name-input").focus();
        }
        // Save button applies name change
        if (e.target.classList.contains("save-person")) {
          const td = e.target.closest(".team-name-cell");
          const input = td.querySelector(".team-name-input");
          const newName = input.value.trim();
          const index = e.target.dataset.index;
          if (newName) {
            peopleList[index].name = newName;
            savePeople();
            renderPeopleList();
            calculateSchedule();
          }
        }
      });

    // Handle Enter key in name input to save
    document
      .getElementById("team-table-body")
      .addEventListener("keydown", (e) => {
        if (
          e.target.classList.contains("team-name-input") &&
          e.key === "Enter"
        ) {
          const td = e.target.closest(".team-name-cell");
          const input = td.querySelector(".team-name-input");
          const newName = input.value.trim();
          const index = td.parentElement.dataset.index;
          if (newName) {
            peopleList[index].name = newName;
            savePeople();
            renderPeopleList();
            calculateSchedule();
          }
        }
      });

    document
      .getElementById("team-table-body")
      .addEventListener("change", (e) => {
        if (e.target.type === "color") {
          const index = e.target.dataset.index;
          peopleList[index].color = e.target.value;
          savePeople();
          calculateSchedule();
        }
      });

    // ...existing code...

    // Add event listeners for saving settings and recalculating schedule
    startDateInput.addEventListener("change", () => {
      saveSettings();
      calculateSchedule();
    });

    shiftLengthInput.addEventListener("change", () => {
      saveSettings();
      calculateSchedule();
    });

    shiftLengthInput.addEventListener("input", () => {
      saveSettings();
      calculateSchedule();
    });

    includeFridayCheckbox.addEventListener("change", () => {
      saveSettings();
      calculateSchedule();
    });

    // Add event listener for date mode toggle
    dateModeToggle.addEventListener("change", () => {
      saveSettings();
      updateDateModeDisplay();
    });

    // --- Schedule Calculation and Chart Generation ---
    function calculateSchedule() {
      const peopleCount = peopleList.length;
      if (peopleCount === 0) {
        document.getElementById("team-table-body").innerHTML = "";
        document.getElementById("mean").textContent = "N/A";
        document.getElementById("stdDev").textContent = "N/A";
        chartGridWrapper.innerHTML = "";
        document.getElementById("stdDevChartWrapper").innerHTML = "";
        return;
      }

      const shiftLength = parseInt(
        document.getElementById("shiftLength").value
      );
      const includeFriday = document.getElementById("includeFriday").checked;
      const totalDaysInYear = 365;
      const useNext12Months = dateModeToggle.checked;

      chartGridWrapper.innerHTML = "";
      document.getElementById("stdDevChartWrapper").innerHTML = "";

      const weekendDaysPerPerson = new Array(peopleCount).fill(0);
      const dailySchedule = new Array(totalDaysInYear).fill(-1);

      // Determine start date based on mode
      let startDate;
      if (useNext12Months) {
        // Next 12 months mode - use today as start date
        startDate = new Date();
      } else {
        // Specific start date mode - use the selected date
        startDate = new Date(startDateInput.value + "T00:00:00");
      }

      // Reference dates for calculations
      const firstDayOfYearDate = new Date(startDate.getFullYear(), 0, 1);
      const startDayOffset = Math.floor(
        (startDate - firstDayOfYearDate) / (1000 * 60 * 60 * 24)
      ); // Assign team members to shifts
      for (let day = 0; day < totalDaysInYear; day++) {
        const shiftNumber = Math.floor(day / shiftLength);
        const personIndex = shiftNumber % peopleCount;
        dailySchedule[day] = personIndex;

        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + day);
        const dayOfWeek = currentDate.getDay();
        let isWeekendDay = false;
        if (includeFriday) {
          if (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0) {
            isWeekendDay = true;
          }
        } else {
          if (dayOfWeek === 6 || dayOfWeek === 0) {
            isWeekendDay = true;
          }
        }
        if (isWeekendDay) {
          weekendDaysPerPerson[personIndex]++;
        }
      }

      let totalDaysOnCallSum = 0;
      // Fill the merged table's Weekend Call Days column
      const teamTableBody = document.getElementById("team-table-body");
      if (teamTableBody) {
        [...teamTableBody.children].forEach((tr, i) => {
          const daysTd = tr.querySelector(".weekend-call-days");
          if (daysTd) {
            daysTd.textContent = weekendDaysPerPerson[i];
          }
        });
      }
      for (let i = 0; i < peopleCount; i++) {
        totalDaysOnCallSum += weekendDaysPerPerson[i];
      }

      const mean = totalDaysOnCallSum / peopleCount;
      const sumOfSquares = weekendDaysPerPerson.reduce(
        (sum, days) => sum + Math.pow(days - mean, 2),
        0
      );
      const stdDev = Math.sqrt(sumOfSquares / peopleCount);

      document.getElementById("mean").textContent = mean.toFixed(2);
      document.getElementById("stdDev").textContent = stdDev.toFixed(2);
      // Dynamic roadsign color using Bootstrap classes
      const meanSign = document.getElementById("mean-roadsign");
      const stdDevSign = document.getElementById("stddev-roadsign");
      if (meanSign && stdDevSign) {
        if (mean > 15) {
          meanSign.classList.remove("bg-success");
          meanSign.classList.add("bg-danger", "text-white");
        } else {
          meanSign.classList.remove("bg-danger");
          meanSign.classList.add("bg-success", "text-white");
        }
        if (stdDev > 1) {
          stdDevSign.classList.remove("bg-success");
          stdDevSign.classList.add("bg-danger", "text-white");
        } else {
          stdDevSign.classList.remove("bg-danger");
          stdDevSign.classList.add("bg-success", "text-white");
        }
      }

      // --- Standard Deviation Bell Curve Chart with D3.js ---
      const stdDevChartWrapper = document.getElementById("stdDevChartWrapper");
      stdDevChartWrapper.innerHTML = "";
      // Create a container div for D3
      const d3Container = document.createElement("div");
      d3Container.id = "d3-bellcurve";
      stdDevChartWrapper.appendChild(d3Container);

      // D3 chart code
      setTimeout(function () {
        var data = [];
        var meanVal = mean;
        var stdVal = stdDev;
        // Generate quantile/probability pairs
        for (var i = 0; i < 1000; i++) {
          var q = meanVal + stdVal * normal();
          var p = gaussian(q, meanVal, stdVal);
          data.push({ q: q, p: p });
        }
        data.sort(function (x, y) {
          return x.q - y.q;
        });

        var margin = { top: 20, right: 20, bottom: 30, left: 50 },
          width = 500 - margin.left - margin.right,
          height = 220 - margin.top - margin.bottom;

        var x = d3.scale.linear().range([0, width]);
        var y = d3.scale.linear().range([height, 0]);

        var xAxis = d3.svg.axis().scale(x).orient("bottom");
        var yAxis = d3.svg.axis().scale(y).orient("left");

        // Format axis ticks for clarity
        xAxis.tickFormat(d3.format(".0f"));
        yAxis.tickFormat(d3.format(".2f"));

        var line = d3.svg
          .line()
          .x(function (d) {
            return x(d.q);
          })
          .y(function (d) {
            return y(d.p);
          });

        var svg = d3
          .select("#d3-bellcurve")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        x.domain(
          d3.extent(data, function (d) {
            return d.q;
          })
        );
        y.domain(
          d3.extent(data, function (d) {
            return d.p;
          })
        );

        svg
          .append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
          .append("text")
          .attr("class", "label")
          .attr("x", width / 2)
          .attr("y", 28)
          .style("text-anchor", "middle")
          .style("font-size", "14px")
          .text("Weekend Call Days");

        svg
          .append("g")
          .attr("class", "y axis")
          .call(yAxis)
          .append("text")
          .attr("class", "label")
          .attr("transform", "rotate(-90)")
          .attr("y", -40)
          .attr("x", -height / 2)
          .attr("dy", ".71em")
          .style("text-anchor", "middle")
          .style("font-size", "14px")
          .text("Probability Density");

        svg.append("path").datum(data).attr("class", "line").attr("d", line);

        // Draw legend
        var legend = document.createElement("div");
        legend.style.display = "flex";
        legend.style.flexDirection = "column";
        legend.style.justifyContent = "flex-end";
        legend.style.alignItems = "flex-end";
        legend.style.marginTop = "10px";
        legend.style.minWidth = "120px";
        legend.style.fontSize = "14px";
        legend.style.border = "2px solid #bbb";
        legend.style.borderRadius = "8px";
        legend.style.background = "#fff";
        legend.style.padding = "16px 15px 16px 16px";
        legend.style.marginLeft = "auto";
        peopleList.forEach((person, idx) => {
          var legendItem = document.createElement("div");
          legendItem.style.display = "flex";
          legendItem.style.alignItems = "center";
          legendItem.style.marginBottom = "8px";
          var colorDot = document.createElement("span");
          colorDot.style.display = "inline-block";
          colorDot.style.width = "16px";
          colorDot.style.height = "16px";
          colorDot.style.borderRadius = "50%";
          colorDot.style.backgroundColor = person.color;
          colorDot.style.marginRight = "8px";
          legendItem.appendChild(colorDot);
          legendItem.appendChild(document.createTextNode(person.name));
          legend.appendChild(legendItem);
        });
        stdDevChartWrapper.appendChild(legend);

        // Helper functions
        function normal() {
          var x = 0,
            y = 0,
            rds,
            c;
          do {
            x = Math.random() * 2 - 1;
            y = Math.random() * 2 - 1;
            rds = x * x + y * y;
          } while (rds == 0 || rds > 1);
          c = Math.sqrt((-2 * Math.log(rds)) / rds);
          return x * c;
        }
        function gaussian(x, mean, sigma) {
          var gaussianConstant = 1 / Math.sqrt(2 * Math.PI);
          x = (x - mean) / sigma;
          return (gaussianConstant * Math.exp(-0.5 * x * x)) / sigma;
        }
      }, 0);

      // --- Chart Generation ---
      const totalWeeksToShow = 53; // Show approx 1 year (52-53 weeks)

      // Create a simplified month header
      const monthHeader = document.createElement("div");
      monthHeader.classList.add("month-header");

      // Set up day labels for y-axis (Sun at top, Sat at bottom)
      const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      const chartGrid = document.createElement("div");
      chartGrid.classList.add("chart-grid");

      // Create reference dates for chart generation
      let chartStartDate, chartEndDate;

      if (useNext12Months) {
        // For Next 12 Months mode:
        // Find the start of the current week (Sunday)
        chartStartDate = new Date(startDate);
        const dayOfWeek = chartStartDate.getDay();
        chartStartDate.setDate(chartStartDate.getDate() - dayOfWeek); // Go back to Sunday

        // Calculate end date (about 12 months from start)
        chartEndDate = new Date(chartStartDate);
        chartEndDate.setDate(chartStartDate.getDate() + totalWeeksToShow * 7);
      } else {
        // For Specific Date mode, show the whole year:
        chartStartDate = new Date(startDate.getFullYear(), 0, 1); // Jan 1st of the year
        chartEndDate = new Date(startDate.getFullYear() + 1, 0, 0); // Dec 31st of the year
      }

      // Generate month labels
      const monthNames = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];
      const weekWidth = 100 / totalWeeksToShow; // Percentage width for each week

      // Track the months to display
      const months = [];
      let currentMonth = new Date(chartStartDate);
      while (currentMonth < chartEndDate) {
        const monthIndex = currentMonth.getMonth();
        const year = currentMonth.getFullYear();
        const monthStart = new Date(year, monthIndex, 1);
        const monthEnd = new Date(year, monthIndex + 1, 0);

        // Calculate which week of the displayed range this month starts and ends in
        const startWeek = Math.floor(
          (monthStart - chartStartDate) / (7 * 24 * 60 * 60 * 1000)
        );
        const endWeek = Math.min(
          Math.floor((monthEnd - chartStartDate) / (7 * 24 * 60 * 60 * 1000)),
          totalWeeksToShow - 1
        );

        // Only add month if it's visible in our range
        if (startWeek < totalWeeksToShow && endWeek >= 0) {
          months.push({
            name:
              monthNames[monthIndex] +
              (year !== startDate.getFullYear()
                ? " '" + year.toString().substr(2)
                : ""),
            startWeek: Math.max(0, startWeek),
            endWeek: endWeek,
            weeks: endWeek - Math.max(0, startWeek) + 1,
          });
        }

        // Move to the next month
        currentMonth.setMonth(currentMonth.getMonth() + 1);
      }

      // Create the month labels with widths proportional to their number of weeks
      for (const monthInfo of months) {
        const monthLabel = document.createElement("div");
        monthLabel.classList.add("month-label");
        monthLabel.textContent = monthInfo.name;
        monthLabel.style.width = `${monthInfo.weeks * weekWidth}%`;
        monthHeader.appendChild(monthLabel);
      }

      chartGridWrapper.appendChild(monthHeader);
      chartGridWrapper.appendChild(chartGrid);

      // Create the GitHub-style tracking chart
      // Each row represents a day of the week (Sun to Sat)
      for (let dayOfWeekIndex = 0; dayOfWeekIndex < 7; dayOfWeekIndex++) {
        // Add the day label (Sun, Mon, etc.)
        const dayLabel = document.createElement("div");
        dayLabel.classList.add("day-label");
        dayLabel.textContent = dayNames[dayOfWeekIndex];
        chartGrid.appendChild(dayLabel);

        // For each week in our display range
        for (let week = 0; week < totalWeeksToShow; week++) {
          // Calculate the date for this specific cell based on chart start date
          const currentDate = new Date(chartStartDate);
          currentDate.setDate(
            chartStartDate.getDate() + week * 7 + dayOfWeekIndex
          );

          // Create a box for this day
          const dayBox = document.createElement("div");
          dayBox.classList.add("day-box");

          // Verify this day's day of week matches what we expect
          if (currentDate.getDay() !== dayOfWeekIndex) {
            console.error(
              "Day mismatch:",
              currentDate,
              "expected day:",
              dayOfWeekIndex,
              "actual:",
              currentDate.getDay()
            );
          }

          // Format the date as YYYY-MM-DD for the tooltip
          const year = currentDate.getFullYear();
          const month = String(currentDate.getMonth() + 1).padStart(2, "0");
          const day = String(currentDate.getDate()).padStart(2, "0");
          const formattedDate = `${year}-${month}-${day}`;

          // Determine if this day is before or after the start date
          if (currentDate < startDate) {
            // Gray out days before the start date
            dayBox.classList.add("gray-out");

            // Add tooltip showing just the date for grayed out days
            const tooltip = document.createElement("span");
            tooltip.classList.add("tooltip");
            tooltip.textContent = formattedDate;
            dayBox.appendChild(tooltip);
          } else {
            // This day is on or after the start date
            const scheduleIndex = Math.floor(
              (currentDate - startDate) / (1000 * 60 * 60 * 24)
            );

            if (scheduleIndex < totalDaysInYear) {
              const onCallPersonIndex = dailySchedule[scheduleIndex];

              if (onCallPersonIndex !== -1 && peopleList[onCallPersonIndex]) {
                // Color the box with the team member's color
                dayBox.style.backgroundColor =
                  peopleList[onCallPersonIndex].color;

                // Add tooltip showing the team member's name and date
                const tooltip = document.createElement("span");
                tooltip.classList.add("tooltip");
                tooltip.textContent = `${peopleList[onCallPersonIndex].name} (${formattedDate})`;
                dayBox.appendChild(tooltip);
              }
            }
          }

          chartGrid.appendChild(dayBox);
        }
      }
    }

    // Load data on page load
    loadSettings();
    updateDateModeDisplay();
    loadPeople();
  </script>
</html>
